## CMCC RX30算力版23.05到24.10升级

2025-01 RX30安装了定制uboot和immoralwrt 23.05版，时间来到2026年，一年以后一些App已经不在23.05上更新而是转向主线24.10.是时候升级24.10继续App的更新了。
目前的系统分区只是对data做了拆分，把一部分容量分给了/overloay。

之前安装的是lgs2007m的uboot，文档中提到可以支持legacy（bin格式image）和openwrt/immortalwrt主线FIP（itb格式image）。在恩山论坛的无线路由板块lgs2007m也在一个帖子里提到：
我改的uboot和gpt目前已同时支持21.02闭源固件(.bin格式Legacy image)和openwrt、immortalwrt主线master/23.05分支固件(.itb格式FIT image)直接刷入启动，可在SSH修改环境变量，直接切换启动两种固件，无需重刷，配置保留。
最新24.10没试过，应该也可以启动。

那么什么是SSH环境变量呢？以下是lgs2007m原文档里的表述：

uboot刷机是不保留配置的，如果已经刷好两种固件不想重刷，可以在系统里修改环境变量，重启即可切换启动的固件，配置保留。
当前在openwrt、immortalwrt主线master/23.05分支固件(.itb格式FIT image)，要切换到闭源固件(.bin格式Legacy image)
运行下面命令修改环境变量，没有报错即可，然后reboot重启
```
cp /etc/fw_env.config /etc/fw_env.config.bak
echo -e "/dev/mmcblk0p1 0 0x80000" > /etc/fw_env.config
fw_setenv dual_boot.current_slot 0
cp /etc/fw_env.config.bak /etc/fw_env.config
```
当前在闭源固件(.bin格式Legacy image)，要切换到openwrt、immortalwrt主线master/23.05分支固件(.itb格式FIT image)
运行下面命令修改环境变量，没有报错即可，然后reboot重启
```
fw_setenv dual_boot.current_slot 1
```
但文中也提到了CMCC RX30的一个潜在问题：目前的uboot只能基于目前的CMCC RAX3000M EMMC固件启动，一旦主线有专门的RX30 EMMC固件，那么uboot可能无法启动，必须修改。

直接uboot刷闭源固件(.bin格式Legacy image)或者openwrt、immortalwrt主线master/23.05分支固件(.itb格式FIT image)，可以直接启动。<br>
【注意】openwrt、immortalwrt主线master/23.05分支固件(.itb格式FIT image)固件第一次启动有点慢，特别是集成docker的固件，第一次启动可能需要5分钟，耐心等待，后面再启动就快了。<br>
【注意】由于主线RAX3000M-NAND和RAX3000M-eMMC使用all in fit，一个固件集合了NAND和eMMC固件，启动时需要选择对应的fdt才可正常启动eMMC的固件。我已通过uboot自动判断，如果从kernel分区启动闭源固件(.bin格式Legacy image)则删除这个环境变量，如果从production分区启动主线master/23.05分支固件(.itb格式FIT image)，则设置bootconf config-1#mt7981b-cmcc-rax3000m-emmc，这个是自动的。<br>
【注意】主线目前还没有XR30和RAX3000Z增强版（XR30-eMMC）支持，所以我设置bootconf直接使用config-1#mt7981b-cmcc-rax3000m-emmc，能支持主线RAX3000M-eMMC固件启动，但主线支持XR30-eMMC后是不能启动的，得修改uboot源码，改这个bootconf设置。XR30-eMMC比RAX3000M-eMMC少一个LED，XR30-eMMC的eMMC可以跑52MHz，RAX3000M-eMMC的eMMC跑26MHz。

目前为止，并没有主线的RX30或者所谓的RAX3000Z EMMC固件支持。还是需要使用RAX3000M EMMC的固件刷机，这样似乎目前的uboot还能继续使用。
理论上只要准备好新的sysupgrade.itb，机器重启到uboot刷机状态，直接刷机就能无痛升级到24.10.x版本的immortalwrt。
immortalwrt在[ImmortalWRT Selector](https://fwselector.kyarucloud.moe/)上面输入路由器型号RAX3000M，用Customer installed packages指定所需的预装App即可，例如添加：
luci-app-homeproxy luci-i18n-homeproxy-zh-cn sing-box
然后点击REQUEST BUILD，等待几分钟即可生成所需的itb文件。

经过测试，目前的uboot无法直接用recovery或者sysupgrade的itb （FIT）image刷机。直接报错，不识别文件！这条路被彻底堵死。我在lgs2007m GitHub里注册了一个issue，看怎么回复。
同时，在恩山的帖子里有一篇帖子专门讨论了[重刷uboot安装ImmortalWrt24.10.0 itb 格式固件](https://www.right.com.cn/FORUM/thread-8418450-1-1.html)

方法如下：
1. 下载immortalwrt 24.10 原版的EMMC-GPT.bin 和EMMC-PRELOADER.bin，再下载一个新uboot：(https://drive.wrt.moe/uboot/mediatek/mt7981-cmcc_rax3000m-emmc-fip-fit.bin)
2. 启动uboot，进入192.168.1.1/gpt.html，刷入MMC-GPT.bin 的分区固件
3. 再进入192.168.1.1/bl2.html，刷入EMMC-PRELOADER.bin 的PRELOADER固件
4. 重启路由，再次进入uboot，输入192.168.1.1/uboot.html，刷入新的适配itb的uboot文件：mt7981-cmcc_rax3000m-emmc-fip-fit.bin
5. 重启路由，进入新的uboot，刷入先刷immortalwrt-24.10.x-mediatek-filogic-cmcc_rax3000m-initramfs-recovery.itb文件
6. 如果成功，可以进入LUCI，那么再进入系统升级，刷入：mmortalwrt-24.10.0-mediatek-filogic-cmcc_rax3000m-squashfs-sysupgrade.itb文件
7. 这时，必须使用主线的immortalwrt itb文件升级或者降级了

有待测试。。。
